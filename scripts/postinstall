#!/usr/bin/env node

import { execSync } from "node:child_process";

if (process.env.CI) {
    console.log("CI environment detected, skipping postinstall script.");
    process.exit(0);
}

try {
    // Only run migrations if not in production, or if explicitly allowed
    const isProduction = process.env.NODE_ENV === "production";
    const allowMigrations = process.env.ALLOW_MIGRATIONS === "true";
    let command = "pnpm run prepare && prisma generate";
    if (!isProduction || allowMigrations) {
        command += " && prisma migrate deploy";
    } else {
        console.log("Production environment detected, skipping automatic database migrations. Set ALLOW_MIGRATIONS=true to override.");
    }
    execSync(command, { stdio: "inherit" });
} catch (error) {
    console.error("Postinstall script failed:", error);
    process.exit(1);
}

