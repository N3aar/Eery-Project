#!/usr/bin/env node

import { execSync } from "node:child_process";

if (process.env.CI) {
    console.log("CI environment detected, skipping postinstall script.");
    process.exit(0);
}

try {
    const isProduction = process.env.NODE_ENV === "production";
    const allowMigrations = process.env.ALLOW_MIGRATIONS === "true";

    execSync("prisma generate", { stdio: "inherit" });

    if (!allowMigrations) {
        console.log("Docker build environment detected (ALLOW_MIGRATIONS=false), skipping database migrations.");
        process.exit(0);
    }

    if (!isProduction || allowMigrations) {
        execSync("prisma migrate deploy", { stdio: "inherit" });
    } else {
        console.log("Production environment detected, skipping automatic database migrations. Set ALLOW_MIGRATIONS=true to override.");
    }
} catch (error) {
    console.error("Postinstall script failed:", error);
    process.exit(1);
}
